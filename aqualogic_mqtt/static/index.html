<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Keep existing viewport and add viewport-fit for iOS safe areas -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Hayward PL-PLUS Controller</title>
  <style>
    /* MOBILE-FIRST TUNING */
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100svh; /* mobile Safari small viewport height */
      height: calc(var(--vh, 1vh) * 100); /* JS fallback for iOS */
      margin: 0;
      background-color: #e0f7fa;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      touch-action: manipulation;
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    .panel {
      background-color: #333;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      text-align: center;
      width: min(92vw, 480px); /* responsive width, nice on iPhone screens */
      max-width: 480px;
    }
    .display {
      background-color: #d4edda; /* soft green LCD look */
      color: #000;
      padding: clamp(10px, 2vh, 16px);
      margin-bottom: 12px;
      font-size: clamp(16px, 2.5vh, 20px);
      line-height: 1.2;
      border-radius: 8px;
      white-space: nowrap;     /* single line */
      overflow: hidden;
      text-overflow: ellipsis; /* avoid horizontal cut-off */
      min-height: 2.2em;
    }
    .controls-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      gap: 12px;
    }
    .nav-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 8px;
      width: min(60vw, 220px);
      min-width: 200px;
      margin: 0;
    }
    button {
      background-color: #00bcd4;
      border: none;
      padding: 10px;
      color: white;
      font-weight: 700;
      cursor: pointer;
      border-radius: 10px;
      user-select: none;
      min-width: 44px;
      min-height: 44px; /* Apple HIG minimum */
      font-size: clamp(16px, 2.2vh, 18px);
    }
    button:hover { background-color: #0097a7; }
    .up-button    { grid-column: 2; grid-row: 1; }
    .left-button  { grid-column: 1; grid-row: 2; }
    .center-button{ grid-column: 2; grid-row: 2; }
    .right-button { grid-column: 3; grid-row: 2; }
    .down-button  { grid-column: 2; grid-row: 3; }

    .aux-buttons { display:flex; gap:10px; }
    .filter-btn button {
      background-color: #4caf50;
      padding: 12px 14px;
    }
    .filter-btn button:hover { background-color: #3e8e41; }
    .poolspa-btn button {
      background-color: #7b5cf0; /* purple-ish to differentiate */
      padding: 12px 14px;
    }
    .poolspa-btn button:hover { background-color: #6a49e6; }

    .status {
      color: #ddd;
      font-size: 12px;
      margin-top: 10px;
      opacity: .9;
    }

    /* Very small screens: stack aux buttons under the pad */
    @media (max-width: 420px) {
      .controls-row {
        flex-direction: column;
        align-items: stretch;
      }
      .nav-buttons {
        width: 100%;
        min-width: 0;
      }
      .aux-buttons { justify-content: space-between; }
      .aux-buttons button { flex:1; }
    }
  </style>
</head>
<body>
  <div class="panel">
    <div class="display" id="display">Heater1 Auto Control</div>

    <div class="controls-row">
      <div class="nav-buttons">
        <button class="up-button"     data-k="plus">+</button>
        <button class="left-button"   data-k="left">&lt;</button>
        <button class="center-button" data-k="menu">Menu</button>
        <button class="right-button"  data-k="right">&gt;</button>
        <button class="down-button"   data-k="minus">−</button>
      </div>

      <div class="aux-buttons">
        <div class="filter-btn">
          <button data-k="filter">Filter</button>
        </div>
        <div class="poolspa-btn">
          <button data-k="pool_spa">Pool/Spa</button>
        </div>
      </div>
    </div>

    <div class="status" id="status">Connecting…</div>
  </div>

  <script>
  // iOS Safari dynamic viewport height fix
  function setVhUnit(){
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
  }
  window.addEventListener('resize', setVhUnit);
  window.addEventListener('orientationchange', setVhUnit);
  setVhUnit();

  const displayEl = document.getElementById('display');
  const statusEl  = document.getElementById('status');

  function collapseLines(lines) {
    // Trim each piece, drop NULs, collapse multi-spaces
    const parts = (lines || [])
      .filter(Boolean)
      .map(s => String(s).replace(/\x00/g, '').trim());
    const text = parts.join(' ').replace(/\s{2,}/g, ' ');
    return text.trim();
  }

  async function poll() {
    try {
      const res = await fetch('/api/display', { cache: 'no-store' });
      if (!res.ok) throw new Error(res.statusText);
      const j = await res.json();
      displayEl.textContent = collapseLines(j.lines) || '\u00a0';
      statusEl.textContent = `Updated ${new Date(j.updated_at * 1000).toLocaleTimeString()}`;
    } catch (e) {
      statusEl.textContent = 'Disconnected';
    } finally {
      setTimeout(poll, 600);
    }
  }

  async function sendKey(k) {
    try {
      const res = await fetch(`/api/key/${encodeURIComponent(k)}`, { method: 'POST' });
      await res.json().catch(()=>{});
    } catch (_) { /* quiet */ }
  }

  // Click handlers for all buttons
  document.querySelectorAll('button[data-k]').forEach(btn => {
    btn.addEventListener('click', () => sendKey(btn.dataset.k));
  });

  // Keyboard shortcuts (desktop convenience)
  window.addEventListener('keydown', (e) => {
    if (e.repeat) return;
    if (e.key === 'ArrowLeft')  return sendKey('left');
    if (e.key === 'ArrowRight') return sendKey('right');
    if (e.key === '-' )         return sendKey('minus');
    if (e.key === '=' || e.key === '+') return sendKey('plus');
    if (e.key === 'm' || e.key === 'M')  return sendKey('menu');
    if (e.key === 'p' || e.key === 'P')  return sendKey('pool_spa'); // Pool/Spa shortcut
  });

  poll();
  </script>
</body>
</html>